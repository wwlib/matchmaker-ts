<html>
<head>
    <title>matchmaker-ts</title>
    <link rel="stylesheet" href="css/bootstrap.css" type="text/css">
    <style>
      html {
          display: table;
          margin: auto;
      }

      body {
          display: table-cell;
          vertical-align: middle;
          max-width: 800px;
      }

      img {
          box-shadow: 3px 3px 8px #cccccc;
      }
    </style>
</head>
<body>


    <h2 id="matchmakerts">matchmaker-ts</h2>

<p><a href="https://github.com/wwlib/matchmaker-ts">https://github.com/wwlib/matchmaker-ts</a></p>

<p><img src="./img/matchmaker-ts.png" alt="matchmaker-ts" /></p>

<p>matchmaker-ts is a tool for designing and analyzing multiplayer matchmaking.  </p>

<h3 id="buildrun">Build &amp; Run</h3>

<pre><code class="bash language-bash">yarn
yarn start
</code></pre>

<h3 id="documentation">Documentation</h3>

<p><a href="https://wwlib.github.io/matchmaker-ts/typedoc/index.html">https://wwlib.github.io/matchmaker-ts/typedoc/index.html</a></p>

<h3 id="gettingstarted">Getting Started</h3>

<p>matchmaker-ts provides a GUI for controlling and testing the server. The GUI also allows matchmaker-ts to act as a client app that can connect to the server.</p>

<p>For example:</p>

<ul>
<li>mock clients/players can be generated by clicking the <code>addMockClient</code> button


<ul>
<li>these will be added to lobbies and matched</li></ul>
</li>

<li>clicking the <code>step</code> button below the stats graph will add the current number-of-lobbies and number-of-clients as graph data points</li>

<li>clicking the <code>startSim</code> button will cause new clients to be created continuously (rapidly)</li>

<li>periodically clicking <code>step</code> will add real time data points to the graph</li>

<li>clicking the <code>on</code> button  below the stats graph will cause the graph to update continuously


<ul>
<li>Note: this is not yet well-optimized and may not perform well over time</li></ul>
</li>
</ul>

<p>Using the client app:</p>

<ul>
<li>launch another instance of matchmaker-ts (on the same machine, for now)</li>

<li>in both clients, click the <code>connect</code> button</li>

<li>then type messages in the clients' <code>&lt;input&gt;</code> fields</li>

<li>the messages should be relayed between clients and displayed in the <code>&lt;messages&gt;</code> fields</li>

<li>Note: when these special clients connect to the server they are added to a ChatLobby which does not attempt any matchmaking. This allows the clients to chat indefinitely. Up to 8 clients will be added to the special ChatLobby. Subsequent connections are treated normally.</li>
</ul>

<h3 id="overviewandarchitecture">Overview and Architecture</h3>

<p>matchmaker-ts is a real time multiplayer server written in TypeScript with an Electron/React front-end for analysis and testing.  </p>

<p><img src="./img/matchmaker-ts-architecture.png" alt="matchmaker-ts-architecture" /></p>

<h4 id="director">Director</h4>

<p>The Director coordinates the servers subsystems.</p>

<ul>
<li>Instantiates the ConnectionManager</li>

<li>Manages communication with the Database</li>

<li>Manages the lifecycle of Lobbies


<ul>
<li>whenever a new player connects, the Director either:</li>

<li>adds the player to an existing Lobby or</li>

<li>creates a new Lobby appropriate for that player</li></ul>
</li>

<li>Manages the lifecycle of authenticated TCPClientSessions</li>

<li>Creates and destroys ClientProxy instances used to relay messages between TCPClientSessions and GameWorlds (Lobbies)</li>

<li>Manages the creation of clients used for testing the server


<ul>
<li>mock clients = a mock TCPClientSession + ClientProxy</li>

<li>mock clients are added to Lobbies just like actual clientSession</li></ul>
</li>

<li>Manages the creation/clean-up of (mock) PlayerAccounts</li>
</ul>

<p>Pub/Sub</p>

<ul>
<li>The Director currently uses a local/in-memory pub/sub module (PubSubJS) to relay messages between TCP connections and Lobby/GameWorlds</li>

<li>Greater scalability could be achieved by using Redis which would allow messages to be shared between multiple server instances</li>
</ul>

<p>Primary/Replica</p>

<ul>
<li>The Director is designed to have two modes: Primary and Replica (unimplemented)</li>

<li>In Primary mode, the Director acts as the authoritative Database and owner/director of Lobby/GameWorld instances</li>

<li>The Replica Director would rely on the Primary Director to distribute Lobby/GameWorld creation/management responsibility across all instances.</li>

<li>In Replica mode, the Director would instantiate a ConnectionManager and accept TCP connections routed to it by a load balancer. Messaging between Primary and Replica instances would be via pub/sub</li>

<li>A more scalable approach would allow Replica instances to also create/manage Lobby/GameWorld instances</li>
</ul>

<h4 id="matchmaking">Matchmaking</h4>

<p>The Director coordinates matchmaking by:</p>

<ul>
<li>finding the most appropriate Lobby instance for each new player/client


<ul>
<li>each existing Lobby is queried to see if it will accept the player: <code>Lobby: willAcceptPlayer(player: PlayerAccount): boolean</code></li>

<li>if no Lobby will accept the player, a new lobby is created for that player: <code>Director: addLobbyWithPlayerAccount(player: PlayerAccount): Lobby</code></li></ul>
</li>
</ul>

<p>Lobby instances accept players based on configurable criteria:</p>

<ul>
<li>PlayerLocation (i.e. NorthAmericaEast)</li>

<li>Player MMR score: using an <code>mmrRange</code>, i.e <code>{min: 1001, max: 1800}</code></li>

<li>Unimplemented: latency, business priority, behavior profile (history of quitting), etc.</li>
</ul>

<p>Matching</p>

<ul>
<li>The Lobby is responsible for matching players</li>

<li>The current matching algorithm is simplistic and assumes 1v1 matching (teams are not supported, yet)</li>

<li>Periodically (every <code>deltaTime</code>, i.e. 1 second) every player in the lobby is compared to every other player to determine if a match is acceptable: <code>willMatchClients(client1: ClientProxy, client2: ClientProxy): boolean</code></li>

<li>A greedy approach is used so that matchable players are immediately matched</li>

<li>Players will be matched if the difference between their MMR scores is less than the Lobby's <code>maxClientMMRDifference</code> (i.e. 100 points)</li>

<li>If a pair's combined wait time in the lobby exceeds the Lobby's <code>maxCombinedClientWaitTime</code> (i.e. 30 seconds) the pair will be matched</li>
</ul>

<p>GamePlay</p>

<ul>
<li>The current implementation does not involve actual or simulated gameplay</li>

<li>As soon as a match is made, the players are disposed by the Director: <code>handleGameOver(client1: ClientProxy, client2: ClientProxy): void</code></li>
</ul>

<h4 id="clientproxy">ClientProxy</h4>

<p>The ClientProxy class acts as a bridge between the TCPClientSessions (sockets) and Lobby/GameWorld instances. This abstraction anticipates the need to distribute socket connections across server instances/machines for scalability. The ClientProxy publishes and subscribes to channels identified by the player's UUID. The ClientProxy receives messages when the TCPClientSession publishes to the player's inbound channel ([UUID].in) and relays these to the Lobby/GameWorld to which the player has been added. The TCPClientSession sends messages via the socket which it receives via the player's [UUID].out channel. As noted, this would allow for TCPClientSessions to be hosted by multiple servers/machines.</p>

<h4 id="messages">Messages</h4>

<p>matchmaker-ts anticipates the need to optimize message sizes and uses schemapack to pack JavaScript Objects (JSON) into compact binary messages.  </p>

<p>Note: The currently implemented message types use string payloads. Packing is most effective with simpler payload types.</p>

<h4 id="scalabilityconsiderations">Scalability Considerations</h4>

<p>The standard way to scale multiplayer matching to millions of players/connections it to run multiple server instances fed by a load balancer. In this architecture, each server manages thousands of connections, lobbies and game worlds. Messages are routed between server instances using a pub/sub service like Redis. Redis also serves as the shared, in-memory database for all server instances.</p>

<p>matchmaker-ts anticipates this architecture by using a local pub/sub module (PubSubJS) that could be swapped out for node-redis. As noted above, the Director is designed to have Primary and Replica modes where the Replica Director would rely on the Primary Director to distribute Lobby/GameWorld creation/management responsibility across all instances.</p>

<p>For example: Amazon's GameLift service can provide a highly scalable multi-server architecture using redis. GameLift's matchmaking service also provides a configurable, scalable mechanism for matchmaking.</p>

<ul>
<li><p><a href="https://aws.amazon.com/gamelift/">https://aws.amazon.com/gamelift/</a></p></li>

<li><p><a href="https://hackernoon.com/serverless-websockets-with-aws-lambda-fanout-15384bd30354">https://hackernoon.com/serverless-websockets-with-aws-lambda-fanout-15384bd30354</a></p></li>

<li><p><a href="https://aws.amazon.com/blogs/database/how-to-build-a-chat-application-with-amazon-elasticache-for-redis/">https://aws.amazon.com/blogs/database/how-to-build-a-chat-application-with-amazon-elasticache-for-redis/</a>
<img src="./img/amazon-redis.png" alt="amazon-redis" /></p></li>

<li><p><a href="https://medium.com/containers-on-aws/scaling-a-realtime-chat-app-on-aws-using-socket-io-redis-and-aws-fargate-4ed63fb1b681">https://medium.com/containers-on-aws/scaling-a-realtime-chat-app-on-aws-using-socket-io-redis-and-aws-fargate-4ed63fb1b681</a>
<img src="./img/medium-redis.png" alt="medium-redis" /></p></li>

<li><p><a href="https://medium.com/digg-data/the-way-of-the-gopher-6693db15ae1f">https://medium.com/digg-data/the-way-of-the-gopher-6693db15ae1f</a></p></li>
</ul>

<h4 id="performance">Performance</h4>

<p>There is room for a lot of performance tuning in the current implementation. As noted above, the matching algorithm is simplistic. The Electron wrapper is useful for design and development. A headless node instances would be used in production.</p>

<h4 id="matchingconsiderations">Matching Considerations</h4>

<p>Matching is an interesting (hard) problem and the subject of previous and ongoing research. These relevant links address both intuitive and counter-intuitive strategies for maximizing player engagement:</p>

<p>AWS  </p>

<ul>
<li><a href="https://aws.amazon.com/blogs/gametech/matchmaking-your-way-amazon-gamelift-flexmatch-and-game-session-queues/">https://aws.amazon.com/blogs/gametech/matchmaking-your-way-amazon-gamelift-flexmatch-and-game-session-queues/</a></li>

<li><a href="https://docs.aws.amazon.com/gamelift/latest/developerguide/match-configuration.html">https://docs.aws.amazon.com/gamelift/latest/developerguide/match-configuration.html</a></li>

<li><a href="https://aws.amazon.com/blogs/gametech/fitting-the-pattern-serverless-custom-matchmaking-with-amazon-gamelift/">https://aws.amazon.com/blogs/gametech/fitting-the-pattern-serverless-custom-matchmaking-with-amazon-gamelift/</a></li>
</ul>

<p>Research  </p>

<ul>
<li><a href="https://www.firstpost.com/tech/gaming/university-of-michigan-researchers-create-better-matchmaking-algorithms-for-multiplayer-games-3725015.html">https://www.firstpost.com/tech/gaming/university-of-michigan-researchers-create-better-matchmaking-algorithms-for-multiplayer-games-3725015.html</a></li>

<li><a href="https://arstechnica.com/gaming/2018/01/ea-has-tested-online-matchmaking-algorithms-to-favor-engagement-not-fairness/">https://arstechnica.com/gaming/2018/01/ea-has-tested-online-matchmaking-algorithms-to-favor-engagement-not-fairness/</a></li>

<li><a href="https://digit.hbs.org/submission/video-game-matchmaking-a-data-driven-take-from-blizzard/">https://digit.hbs.org/submission/video-game-matchmaking-a-data-driven-take-from-blizzard/</a></li>

<li><a href="https://www.researchgate.net/figure/MMR-distribution-of-players_fig1_236887261">https://www.researchgate.net/figure/MMR-distribution-of-players_fig1_236887261</a></li>

<li><a href="https://en.wikipedia.org/wiki/Stable_marriage_problem">https://en.wikipedia.org/wiki/Stable_marriage_problem</a></li>

<li><a href="http://www.diva-portal.se/smash/get/diva2:873273/FULLTEXT01.pdf">http://www.diva-portal.se/smash/get/diva2:873273/FULLTEXT01.pdf</a></li>

<li><a href="http://papers.www2017.com.au.s3-website-ap-southeast-2.amazonaws.com/proceedings/p1143.pdf">http://papers.www2017.com.au.s3-website-ap-southeast-2.amazonaws.com/proceedings/p1143.pdf</a></li>

<li><a href="http://joostdevblog.blogspot.com/2014/11/why-good-matchmaking-requires-enormous.html">http://joostdevblog.blogspot.com/2014/11/why-good-matchmaking-requires-enormous.html</a></li>

<li><a href="http://sce.carleton.ca/~mfloyd/iccbr11games/papers/Jimenez-Rodriguez.pdf">http://sce.carleton.ca/~mfloyd/iccbr11games/papers/Jimenez-Rodriguez.pdf</a></li>
</ul>

<p>MMR/ELO</p>

<ul>
<li><a href="https://fivethirtyeight.com/features/how-we-calculate-nba-elo-ratings/">https://fivethirtyeight.com/features/how-we-calculate-nba-elo-ratings/</a></li>

<li><a href="https://metinmediamath.wordpress.com/2013/11/27/how-to-calculate-the-elo-rating-including-example/">https://metinmediamath.wordpress.com/2013/11/27/how-to-calculate-the-elo-rating-including-example/</a></li>
</ul>

<p>Experience</p>

<ul>
<li><a href="https://www.epicgames.com/fortnite/forums/battle-royale/royale-with-cheese/139705-connecting-to-matchmaking-service-takes-forever-nowadays-how-can-queue-be-full-o-o">https://www.epicgames.com/fortnite/forums/battle-royale/royale-with-cheese/139705-connecting-to-matchmaking-service-takes-forever-nowadays-how-can-queue-be-full-o-o</a></li>

<li><a href="https://www.epicgames.com/fortnite/forums/suggestions-advice/172539-skill-based-matchmaking">https://www.epicgames.com/fortnite/forums/suggestions-advice/172539-skill-based-matchmaking</a></li>
</ul>

<p>Approach</p>

<ul>
<li><a href="https://wiki.guildwars2.com/wiki/PvP_Matchmaking_Algorithm">https://wiki.guildwars2.com/wiki/PvP_Matchmaking_Algorithm</a></li>

<li><a href="https://www.reddit.com/r/learnprogramming/comments/7rdlzf/how_is_online_game_matchmaking_done_from_a/">https://www.reddit.com/r/learnprogramming/comments/7rdlzf/how_is_online_game_matchmaking_done_from_a/</a></li>

<li><a href="http://www.atonet.se/matchmaking.html">http://www.atonet.se/matchmaking.html</a></li>

<li><a href="https://github.com/eerwitt/node-match-maker">https://github.com/eerwitt/node-match-maker</a></li>
</ul>

<h4 id="dataml">Data/ML</h4>

<p>Using ML (Deep Learning) could be a valubale approach to creating an 'intelligent' adaptive matching strategy - especially given that non-obvious, counter-intuitive factors can contribute to player <strong>engagement</strong>, <strong>retention</strong> and overall <strong>profitability</strong>.</p>

<h4 id="teamsvs1v1">Teams vs 1v1</h4>

<p>Teams are conceptually like a Lobby, made up of players who have often explicitly chosen to play as a team. An approach to team matching would give players a mechanism for joining a specific TeamLobby and then matching TeamLobby instances in a TeamMatchingLobby.</p>

<p>AWS: GameLift</p>

<ul>
<li><a href="https://docs.aws.amazon.com/gamelift/latest/developerguide/match-examples.html">https://docs.aws.amazon.com/gamelift/latest/developerguide/match-examples.html</a></li>
</ul>


</body>
</html>
